---
layout: post
title: "solrcloud-5.2.1 集群部署及测试"
description: solrcloud-5.2.1 集群部署及测试
category: solr
---


# 安装

## 下载Solr-5.2.1安装包

```
wget http://archive.apache.org/dist/lucene/solr/5.2.1/solr-5.2.1.tgz
```
## 从压缩包中抽出安装脚本

```
tar -zxvf solr-5.2.1.tgz  solr-5.2.1/bin/install_solr_service.sh  --strip-components=2
```
## 创建安装目录

```
mkdir -p /data/solr5
```
## 运行安装脚本

```
./install_solr_service.sh solr-5.2.1.tgz -i /data/solr5 -d /data/solr5 -u solr -s solr -p 8983
```
具体参数说明可以看安装脚本 `install_solr_service.sh`

```
  echo ""
  echo "Usage: install_solr_service.sh path_to_solr_distribution_archive OPTIONS"
  echo ""
  echo "  The first argument to the script must be a path to a Solr distribution archive, such as solr-5.0.0.tgz"
  echo "    (only .tgz or .zip are supported formats for the archive)"
  echo ""
  echo "  Supported OPTIONS include:"
  echo ""
  echo "    -d     Directory for live / writable Solr files, such as logs, pid files, and index data; defaults to /var/solr"
  echo ""
  echo "    -i     Directory to extract the Solr installation archive; defaults to /opt/"
  echo "             The specified path must exist prior to using this script."
  echo ""
  echo "    -p     Port Solr should bind to; default is 8983"
  echo ""
  echo "    -s     Service name; defaults to solr"
  echo ""
  echo "    -u     User to own the Solr files and run the Solr process as; defaults to solr"
  echo "             This script will create the specified user account if it does not exist."
  echo ""
  echo " NOTE: Must be run as the root user"
  echo ""
```

也可以直接解压安装包，然后自定义配置，安装脚本已经做了一些配置逻辑，大致流程如下：

- 判断系统类型 Debian、RedHat、Ubuntu、SUSE（选择下面具体的执行命令）
- 解压安装，此处用到上述的参数指定，不指定，使用默认值配置
- 判断是否存在 /etc/init.d/$SOLR_SERVICE，$SOLR_SERVICE为-s配置，存在直接退出
- 判断配置solr用户是否存在，不存在则创建用户
- 创建data、logs目录，复制`/server/solr/solr.xml`、`/bin/solr.in.sh`、`/server/resources/log4j.properties`配置文件到指定安装目录，并给solr用户授权 `chown -R $SOLR_USER: $SOLR_VAR_DIR`
- 将配置文件信息写入`$SOLR_VAR_DIR/solr.in.sh`中,如下所示

```
SOLR_PID_DIR=/data/solr5
SOLR_HOME=/data/solr5/data
LOG4J_PROPS=/data/solr5/log4j.properties
SOLR_LOGS_DIR=/data/solr5/logs
SOLR_PORT=8983
```
- 复制启动脚本solr，并授权
```
cp $SOLR_INSTALL_DIR/bin/init.d/solr /etc/init.d/$SOLR_SERVICE
chmod 744 /etc/init.d/$SOLR_SERVICE
chown root:root /etc/init.d/$SOLR_SERVICE
```
- 将环境基本配置信息写入`/etc/init.d/solr`
- 启动solr  `service solr start`
- 判断启动状态 `service solr status`
- 安装结束

其实也可以大致看一下`/etc/init.d/solr`中干了啥操作,无非就是下面几个操作
- 检查运行环境JAVA_HOME
- 执行组装启动脚本 

## 集群配置

执行以下命令编辑solr.in.sh文件

```
vim /data/solr5/solr.in.sh
```
参照如下进行修改
```
ZK_HOST="172.16.185.68:2181,172.16.185.69:2181,172.16.185.70:2181"
```

重复按照上述步骤在其他节点执行安装

# 启动

在Solr集群中各节点执行以下命令启动Solr服务

```
service solr start
```
其实执行的具体命令如下,来自 `/etc/init.d/solr`


```
if [ -n "$RUNAS" ]; then
  su -c "SOLR_INCLUDE=$SOLR_ENV $SOLR_INSTALL_DIR/bin/solr $SOLR_CMD" - $RUNAS
else
  SOLR_INCLUDE=$SOLR_ENV $SOLR_INSTALL_DIR/bin/solr $SOLR_CMD
fi
```
即执行

```
//非solr用户
su -c "SOLR_INCLUDE=/data/solr5/solr.in.sh /data/solr5/solr/bin/solr start" - solr

//sorl用户
SOLR_INCLUDE=/data/solr5/solr.in.sh /data/solr5/solr/bin/solr start
```
查看Solr状态

```
# SOLR_INCLUDE=/data/solr5/solr.in.sh /data/solr5/solr/bin/solr status

Found 1 Solr nodes: 

Solr process 15734 running on port 8983
{
  "solr_home":"/data/solr5/data/",
  "version":"5.2.1 1684708 - shalin - 2015-06-10 23:20:13",
  "startTime":"2018-12-25T03:21:24.774Z",
  "uptime":"0 days, 1 hours, 39 minutes, 36 seconds",
  "memory":"44.6 MB (%9.1) of 490.7 MB",
  "cloud":{
    "ZooKeeper":"172.16.185.68:2181,172.16.185.69:2181,172.16.185.70:2181",
    "liveNodes":"3",
    "collections":"3"}}
```

登录查看

http://172.16.185.68:8983

![image](https://jasperbalcony.github.io/images/solr/s-21.jpg)

# 测试

Solr提供了几种常用的方式来操作，Shell命令、REST API、SolrJ接口等等，根据实际情况选择。下面的操作为了简单方便的演示使用Shell命令的方式。

## 创建一个collection

并上传关联配置文件至Zookeeper
```
/data/solr5/solr/bin/solr create_collection -c captcha -d /data/solr5/solr/server/solr/configsets/sample_techproducts_configs/conf -shards 4 -replicationFactor 3
```

检测collection是否成功创建，在Solr UI中刷新页面，点击Cloud如果成功创建了Collection会显示出Solr的集群拓扑

![image](https://jasperbalcony.github.io/images/solr/s-22.jpg)

## 删除Collection

```
http://172.16.185.69:8983/solr/admin/collections?action=DELETE&name=captcha
```

参考

[SolrCloud-5.2.1 集群部署及测试](https://www.cnblogs.com/wxisme/p/5180120.html)